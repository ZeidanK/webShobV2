# PROMPT CONTEXT PACK

**Purpose**: This file contains non-negotiable rules and terminology for the Event Monitoring and Management Platform. Paste this at the top of EVERY build prompt to prevent drift.

---

## 1. Project Summary

The Event Monitoring and Management Platform is a security and public safety system that aggregates inputs from multiple sources (citizen reports, camera detections, responder observations) into a unified operational view for security operators. Operators see all **Reports** (atomic inputs) and **Events** (aggregated incidents), view live and recorded **video** from **Cameras** via **VMS** integrations, and coordinate responses on a map-based interface. AI detection provides signal input but humans control Event lifecycle decisions. The system enforces strict multi-tenant isolation by `companyId` and maintains full audit trails for all operational actions.

---

## 2. Frozen Terminology (Non-Negotiable)

- **Report**: Atomic input from any source (citizen, camera, responder) with optional attachments. Immutable after creation.
- **Event**: Aggregated incident that links multiple Reports, tracked through lifecycle (active → assigned → resolved → closed).
- **Camera**: Registered video source with location, VMS reference, and operational status.
- **VMS**: Video Management System providing live and recorded video access (Direct RTSP, Milestone, Genetec).
- **Company**: Tenant entity. All queries MUST filter by `companyId`.
- **CorrelationId**: UUID attached to every request, propagated through all logs and service calls for request tracing.
- **Audit Log**: Immutable record of state-changing operations (Event lifecycle, Report linking, Camera changes, permission changes).

---

## 3. Non-Negotiables (Hard Rules)

- **Multi-tenant isolation**: EVERY database query MUST filter by `companyId`. No exceptions.
- **Report immutability**: Reports cannot be edited after submission. Events aggregate Reports.
- **Event human-in-the-loop**: Event lifecycle (create, assign, resolve, close) requires operator action. AI suggests, humans decide.
- **Video is core**: Live and historical video access is required, time-aligned to Reports and Events.
- **Multiple VMS support**: System must support Direct RTSP, Milestone XProtect, and Genetec via adapter pattern.
- **No entity renaming**: Do not rename Report, Event, Camera, Company, or other frozen terms.
- **No scope creep**: Implement ONLY what is defined in the current slice. No additions.
- **CorrelationId everywhere**: Generated in middleware, attached to all requests, propagated to all logs and service calls.
- **Structured logging**: JSON logs only. Never plain text.
- **RBAC enforcement**: Role-Based Access Control enforced at API layer. Roles: `citizen`, `first_responder`, `operator`, `admin`, `company_admin`, `super_admin`.
- **Technology stack (FROZEN)**:
  - Backend: Node.js, TypeScript, Express, MongoDB (Mongoose)
  - Frontend: React, TypeScript, Vite
  - AI Service: Python, FastAPI (placeholder for future ML)
  - Real-time: Socket.IO (introduced in Slice 5)
  - Auth: JWT (web), API Key (mobile)

---

## 4. API & Error Contract (Summary)

### Standard Response Envelope
```json
{
  "success": true,
  "data": { ... },
  "error": { "code": "ERROR_CODE", "message": "...", "details": {} },
  "meta": { "page": 1, "pageSize": 20, "total": 100, ... },
  "correlationId": "uuid"
}
```

### Error Codes
- Format: `SCREAMING_SNAKE_CASE`
- Examples: `RESOURCE_NOT_FOUND`, `VALIDATION_ERROR`, `UNAUTHORIZED`, `TENANT_MISMATCH`

### Auth Headers
- **JWT**: `Authorization: Bearer <token>` (web clients)
- **API Key**: `X-API-Key: <key>` (mobile apps, responder devices)
- **CorrelationId**: `X-Correlation-ID: <uuid>` (optional, auto-generated if missing)

### Swagger/OpenAPI
- REQUIRED for every endpoint
- Use JSDoc annotations in route files
- Accessible at `/api-docs`

---

## 5. Logging & Audit Rules (Summary)

### Structured Logs (Winston)
```json
{
  "timestamp": "ISO 8601",
  "level": "ERROR|WARN|INFO|DEBUG",
  "service": "backend-api",
  "action": "dot.notation.action",
  "correlationId": "uuid",
  "context": { "companyId": "...", "userId": "...", "method": "GET", "path": "/api/events" },
  "duration_ms": 45
}
```

### CorrelationId
- Generated by `correlationIdMiddleware` if not provided
- Attached to `req.correlationId`
- Returned in `X-Correlation-ID` response header
- Included in EVERY log entry

### Audit Logs
Audit logs REQUIRED for:
- Event lifecycle changes (create, assign, resolve, close)
- Report linking/unlinking to Events
- Camera registration, updates, deactivation
- User role/permission changes
- Company settings changes

### Security
- **NEVER log**: passwords, tokens, API keys, raw JWT, PII (phone, email if sensitive)
- **Mask** in logs: database URIs (`//***@`), sensitive fields

---

## 6. Testing Expectations (Summary)

### Requirements
- Every feature MUST include tests as part of Definition of Done
- Unit tests for service methods and business logic
- Integration tests for API endpoints (use Supertest + MongoDB Memory Server)
- Tests MUST verify multi-tenant isolation (test with different `companyId` values)
- Tests MUST verify `correlationId` propagation

### Coverage Targets
- Unit tests: 80% line coverage
- Integration tests: 70% endpoint coverage
- Overall: 70% minimum

### Tools
- Backend: Jest, Supertest, MongoDB Memory Server
- Frontend: Vitest, React Testing Library

### CI/CD
- Tests run on every commit
- Coverage reports required for PR approval 

---

## 7. How This File Is Used

**Paste this entire file at the top of every AI build prompt**, followed by:
1. The relevant slice definition from `00-WORKPLAN.md`
2. The specific task or feature request

This ensures all AI-generated code respects frozen terminology, non-negotiables, API contracts, logging standards, and testing requirements. Treat this file as the project's constitution—violations are considered drift and must be corrected immediately.
