# API Conventions

**Version:** 1.0  
**Date:** January 12, 2026  
**Status:** Frozen Foundation Document

---

## 1. URL Structure

### Base URL
```
https://{host}/api
```

### Resource Naming
- Use **plural nouns** for collections: `/api/reports`, `/api/events`, `/api/cameras`
- Use **kebab-case** for multi-word resources: `/api/event-types`
- Use **path parameters** for resource IDs: `/api/events/:id`
- Use **nested resources** sparingly: `/api/events/:id/reports`

### Examples
```
GET    /api/events              # List events
POST   /api/events              # Create event
GET    /api/events/:id          # Get single event
PATCH  /api/events/:id          # Update event
DELETE /api/events/:id          # Delete event (soft delete)
GET    /api/events/:id/reports  # List reports linked to event
POST   /api/events/:id/reports  # Link report to event
```

---

## 2. HTTP Methods

| Method | Purpose | Idempotent | Request Body |
|--------|---------|------------|--------------|
| GET | Retrieve resource(s) | Yes | No |
| POST | Create resource | No | Yes |
| PATCH | Partial update | Yes | Yes (partial) |
| PUT | Full replacement | Yes | Yes (complete) |
| DELETE | Remove resource | Yes | No |

### Notes
- Prefer `PATCH` over `PUT` for updates (partial updates are more common)
- `DELETE` should be **soft delete** (set `isActive: false`) unless explicitly stated
- Use `POST` for actions that don't fit CRUD: `POST /api/events/:id/assign`

---

## 3. Response Envelope

All API responses use a consistent envelope:

### Success Response
```json
{
  "success": true,
  "data": { /* resource or array */ },
  "meta": {
    "page": 1,
    "pageSize": 20,
    "total": 100,
    "totalPages": 5
  },
  "correlationId": "550e8400-e29b-41d4-a716-446655440000"
}
```

### Error Response
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Human-readable error message",
    "details": {
      "field": "email",
      "reason": "Invalid email format"
    }
  },
  "correlationId": "550e8400-e29b-41d4-a716-446655440000"
}
```

### Response Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `success` | boolean | Yes | `true` for 2xx, `false` for 4xx/5xx |
| `data` | object/array | On success | The response payload |
| `error` | object | On error | Error details |
| `error.code` | string | On error | Machine-readable error code |
| `error.message` | string | On error | Human-readable message |
| `error.details` | object | Optional | Additional error context |
| `meta` | object | For lists | Pagination metadata |
| `correlationId` | string | Yes | Request tracking UUID |

---

## 4. Correlation ID

### Purpose
Every request is assigned a unique `correlationId` (UUID v4) for:
- Request tracing across services
- Log correlation
- Support ticket reference

### Generation
- Generated by the first service receiving the request
- Propagated to all downstream services
- Included in all log entries

### Headers
```
X-Correlation-ID: 550e8400-e29b-41d4-a716-446655440000
```

### Rules
- If client provides `X-Correlation-ID`, use it (for mobile app retry scenarios)
- If not provided, generate new UUID
- Always return in response headers AND body

---

## 5. Authentication

### JWT Authentication (Web)
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
```

### API Key Authentication (Mobile)
```
X-API-Key: emp_abc123_xyzRandomString32chars
```

### Token Structure (JWT Payload)
```json
{
  "sub": "userId",
  "companyId": "companyId",
  "role": "operator",
  "iat": 1704067200,
  "exp": 1704153600
}
```

### Token Lifetimes (CONFIGURABLE DEFAULT)
- Access token: 24 hours
- Refresh token: 30 days

---

## 6. Error Codes

### HTTP Status Codes

| Status | Meaning | When to Use |
|--------|---------|-------------|
| 200 | OK | Successful GET, PATCH, DELETE |
| 201 | Created | Successful POST creating resource |
| 204 | No Content | Successful DELETE with no body |
| 400 | Bad Request | Validation errors, malformed input |
| 401 | Unauthorized | Missing or invalid credentials |
| 403 | Forbidden | Valid credentials, insufficient permissions |
| 404 | Not Found | Resource doesn't exist |
| 409 | Conflict | Duplicate resource, invalid state transition |
| 422 | Unprocessable Entity | Semantic validation failure |
| 429 | Too Many Requests | Rate limit exceeded |
| 500 | Internal Server Error | Unexpected server error |
| 502 | Bad Gateway | Upstream service failure (VMS, AI) |
| 503 | Service Unavailable | Temporary outage |

### Application Error Codes

#### Authentication Errors
| Code | HTTP Status | Description |
|------|-------------|-------------|
| `INVALID_CREDENTIALS` | 401 | Email/password mismatch |
| `TOKEN_EXPIRED` | 401 | JWT has expired |
| `TOKEN_INVALID` | 401 | JWT signature invalid |
| `API_KEY_INVALID` | 401 | Unknown or inactive API key |
| `ACCOUNT_LOCKED` | 403 | Too many failed login attempts |

#### Authorization Errors
| Code | HTTP Status | Description |
|------|-------------|-------------|
| `INSUFFICIENT_PERMISSIONS` | 403 | Role lacks required permission |
| `COMPANY_ACCESS_DENIED` | 403 | Cross-tenant access attempted |
| `RESOURCE_ACCESS_DENIED` | 403 | Cannot access this resource |

#### Validation Errors
| Code | HTTP Status | Description |
|------|-------------|-------------|
| `VALIDATION_ERROR` | 400 | Input validation failed |
| `MISSING_REQUIRED_FIELD` | 400 | Required field not provided |
| `INVALID_FIELD_FORMAT` | 400 | Field format incorrect |
| `INVALID_ENUM_VALUE` | 400 | Value not in allowed list |

#### Resource Errors
| Code | HTTP Status | Description |
|------|-------------|-------------|
| `RESOURCE_NOT_FOUND` | 404 | Requested resource doesn't exist |
| `RESOURCE_ALREADY_EXISTS` | 409 | Duplicate resource |
| `INVALID_STATE_TRANSITION` | 409 | Lifecycle transition not allowed |

#### System Errors
| Code | HTTP Status | Description |
|------|-------------|-------------|
| `INTERNAL_ERROR` | 500 | Unexpected server error |
| `DATABASE_ERROR` | 500 | Database operation failed |
| `VMS_CONNECTION_FAILED` | 502 | Cannot connect to VMS |
| `AI_SERVICE_UNAVAILABLE` | 503 | AI service not responding |

---

## 7. Pagination

### Request Parameters
```
GET /api/events?page=2&pageSize=20&sort=-createdAt
```

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `page` | integer | 1 | Page number (1-indexed) |
| `pageSize` | integer | 20 | Items per page (max: 100) |
| `sort` | string | `-createdAt` | Sort field (prefix `-` for descending) |

### Response Meta
```json
{
  "meta": {
    "page": 2,
    "pageSize": 20,
    "total": 87,
    "totalPages": 5,
    "hasNextPage": true,
    "hasPrevPage": true
  }
}
```

---

## 8. Filtering

### Query Parameters
```
GET /api/events?status=active&priority=high&createdAt[gte]=2026-01-01
```

### Operators
| Operator | Meaning | Example |
|----------|---------|---------|
| (none) | Equals | `status=active` |
| `[gte]` | Greater than or equal | `createdAt[gte]=2026-01-01` |
| `[lte]` | Less than or equal | `createdAt[lte]=2026-01-31` |
| `[in]` | In list | `status[in]=active,assigned` |
| `[ne]` | Not equal | `status[ne]=closed` |

### Text Search
```
GET /api/events?search=fire+downtown
```

---

## 9. Geo-Spatial Queries

### Near Location
```
GET /api/cameras/near?lat=37.7749&lon=-122.4194&radius=1000
```

| Parameter | Type | Description |
|-----------|------|-------------|
| `lat` | float | Latitude |
| `lon` | float | Longitude |
| `radius` | integer | Radius in meters |

### Bounding Box
```
GET /api/events/geo?bbox=-122.5,37.7,-122.3,37.9
```

| Parameter | Type | Description |
|-----------|------|-------------|
| `bbox` | string | `minLon,minLat,maxLon,maxLat` |

---

## 10. Date/Time Format

### Standard Format
All dates use **ISO 8601** format in **UTC**:
```
2026-01-12T15:30:00.000Z
```

### Input Flexibility
- Accept ISO 8601 strings
- Accept Unix timestamps (milliseconds)

### Output Consistency
- Always return ISO 8601 strings in UTC

---

## 11. File Uploads

### Multipart Form Data
```
POST /api/reports
Content-Type: multipart/form-data

title=Fire%20on%20Main%20St
description=Smoke%20visible
location={"type":"Point","coordinates":[-122.4,37.7]}
attachments[]=<file1>
attachments[]=<file2>
```

### Limits (CONFIGURABLE DEFAULT)
- Max file size: 10 MB per file
- Max files per request: 5
- Allowed types: `image/jpeg`, `image/png`, `video/mp4`, `audio/mp3`, `audio/aac`

### Response
```json
{
  "success": true,
  "data": {
    "id": "60d5ec49f1b2c8b1f8c1e4a5",
    "attachments": [
      {
        "id": "att_123",
        "filename": "photo1.jpg",
        "mimeType": "image/jpeg",
        "size": 245678,
        "url": "/api/attachments/att_123",
        "thumbnailUrl": "/api/attachments/att_123/thumbnail"
      }
    ]
  }
}
```

---

## 12. Versioning

### Strategy
- URL path versioning when breaking changes required: `/api/v2/events`
- MVP uses unversioned: `/api/events`
- Add version only when breaking change needed

### Breaking Changes
- Removing fields from response
- Changing field types
- Removing endpoints
- Changing authentication mechanism

### Non-Breaking Changes
- Adding new optional fields
- Adding new endpoints
- Adding new query parameters

---

## 13. Rate Limiting

### Headers
```
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1704067260
```

### Limits (CONFIGURABLE DEFAULT)
- Default: 100 requests per minute
- Authentication endpoints: 10 requests per minute
- File upload: 20 requests per minute

### 429 Response
```json
{
  "success": false,
  "error": {
    "code": "RATE_LIMIT_EXCEEDED",
    "message": "Too many requests. Retry after 60 seconds.",
    "details": {
      "retryAfter": 60
    }
  },
  "correlationId": "..."
}
```

---

## 14. CORS

### Allowed Origins (CONFIGURABLE)
- Development: `http://localhost:3000`, `http://localhost:5173`
- Production: `https://{tenant}.platform.example.com`

### Headers
```
Access-Control-Allow-Origin: https://example.com
Access-Control-Allow-Methods: GET, POST, PATCH, DELETE, OPTIONS
Access-Control-Allow-Headers: Content-Type, Authorization, X-API-Key, X-Correlation-ID
Access-Control-Max-Age: 86400
```

---

## Document History

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2026-01-12 | AI-Assisted | Initial API conventions |

---

*All API implementations must follow these conventions. Deviations require explicit approval and documentation.*
